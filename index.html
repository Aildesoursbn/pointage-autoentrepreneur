<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto-Entrepreneur Pointage</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f4f9;
        }

        .container {
            width: 90%;
            max-width: 400px;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        .chrono-display {
            font-size: 2.5em;
            font-weight: bold;
            color: #4CAF50;
            margin: 15px 0;
            background-color: #e8f5e9;
            padding: 10px;
            border-radius: 8px;
        }

        .buttons-group {
            display: flex;
            justify-content: space-around;
            margin-bottom: 25px;
        }

        .button {
            padding: 15px 20px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
            flex: 1;
            margin: 0 5px;
        }

        #btn-travail-start, #btn-dejeuner-stop { background-color: #4CAF50; color: white; }
        #btn-travail-stop { background-color: #f44336; color: white; }
        #btn-dejeuner-start { background-color: #FFC107; color: #333; }
        .button.end-day { background-color: #795548; color: white; }

        .button:hover:not(:disabled) { opacity: 0.8; }
        .button:disabled { background-color: #ccc; cursor: not-allowed; }

        #total-travail {
            font-size: 1.2em;
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        /* Style pour le r√©capitulatif */
        details {
            text-align: left;
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
            background-color: #e3f2fd; /* Bleu clair pour le r√©cap */
        }

        summary {
            font-weight: bold;
            cursor: pointer;
            padding: 5px 0;
            color: #1976D2;
        }

        #weekly-recap li {
            list-style-type: none;
            padding: 5px 0;
            border-bottom: 1px dotted #ccc;
        }

        #weekly-recap li:last-child {
            border-bottom: none;
        }
        
        /* Nouveau style pour le bouton d'effacement */
        #btn-clear-all {
            margin-top: 20px;
            background-color: #757575; /* Gris fonc√© */
            color: white;
            font-size: 0.9em;
            padding: 10px 15px;
        }

    </style>
</head>
<body>

    <div class="container">
        <h1>Pointage Auto-Entrepreneur ‚è±Ô∏è</h1>

        <div class="chrono-display" id="chrono-display">00:00:00</div>

        <div class="buttons-group">
            <button class="button" id="btn-travail-start" onclick="startTravail()">D√©marrer Travail</button>
            <button class="button" id="btn-travail-stop" onclick="stopTravail()" disabled>Arr√™ter Travail</button>
        </div>

        <div class="buttons-group">
            <button class="button" id="btn-dejeuner-start" onclick="startDejeuner()" disabled>D√©marrer D√©jeuner</button>
            <button class="button" id="btn-dejeuner-stop" onclick="stopDejeuner()" disabled>Arr√™ter D√©jeuner</button>
        </div>

        <p id="total-travail">Temps Travaill√© Aujourd'hui : **00:00:00**</p>
        <button class="button end-day" onclick="finDeJournee()">Fin de Journ√©e & Enregistrer</button>

        <button class="button" id="btn-clear-all" onclick="clearAllData()">Effacer TOUT (Danger ‚ö†Ô∏è)</button>


        <details>
            <summary>R√©capitulatif Hebdomadaire üóìÔ∏è</summary>
            <ul id="weekly-recap">
                </ul>
        </details>

    </div>

    <script>
        // Variables globales
        let travailInterval;
        let dejeunerInterval;
        let tempsTravailTotal = 0; // Temps total de travail en millisecondes
        let debutTravailSegment = null; // Timestamp du d√©but du segment de travail actuel
        let debutDejeuner = null; // Timestamp du d√©but du d√©jeuner
        let etat = 'STOPPE'; // 'TRAVAIL', 'DEJEUNER', 'STOPPE'
        
        // NOUVELLES VARIABLES POUR LES HEURES DE D√âBUT/FIN DE JOURN√âE
        let heureDebutJournee = null; // Timestamp du premier 'D√©marrer Travail' de la journ√©e
        let heureFinJournee = null; // Timestamp du 'Fin de Journ√©e'

        const CHRONO_DISPLAY = document.getElementById('chrono-display');
        const TOTAL_TRAVAIL_DISPLAY = document.getElementById('total-travail');
        const WEEKLY_RECAP = document.getElementById('weekly-recap');
        const BTN_TRAVAIL_START = document.getElementById('btn-travail-start');
        const BTN_TRAVAIL_STOP = document.getElementById('btn-travail-stop');
        const BTN_DEJEUNER_START = document.getElementById('btn-dejeuner-start');
        const BTN_DEJEUNER_STOP = document.getElementById('btn-dejeuner-stop');

        // --- Fonctions d'aide (Formatage & Sauvegarde) ---

        /**
         * Convertit un nombre de millisecondes en format HH:MM:SS.
         * @param {number} ms - Millisecondes.
         * @returns {string} - Format HH:MM:SS.
         */
        function msToHMS(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
            const seconds = String(totalSeconds % 60).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }
        
        /**
         * Convertit un timestamp en format HH:MM.
         * @param {number} timestamp - Timestamp en millisecondes.
         * @returns {string} - Format HH:MM.
         */
        function timestampToHM(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        /** Met √† jour l'affichage du temps total de travail. */
        function updateTravailTotalDisplay() {
            TOTAL_TRAVAIL_DISPLAY.innerHTML = `Temps Travaill√© Aujourd'hui : **${msToHMS(tempsTravailTotal)}**`;
        }

        /** Sauvegarde l'√©tat actuel et le temps total dans localStorage. */
        function saveState() {
            localStorage.setItem('tempsTravailTotal', tempsTravailTotal);
            localStorage.setItem('debutTravailSegment', debutTravailSegment);
            localStorage.setItem('debutDejeuner', debutDejeuner);
            localStorage.setItem('etat', etat);
            localStorage.setItem('lastDate', new Date().toDateString());
            // Sauvegarde de l'heure de d√©but de journ√©e
            localStorage.setItem('heureDebutJournee', heureDebutJournee);
        }

        /** Charge l'√©tat au chargement de la page. */
        function loadState() {
            const savedDate = localStorage.getItem('lastDate');
            if (savedDate !== new Date().toDateString()) {
                // Nouvelle journ√©e, r√©initialisation du temps de travail
                tempsTravailTotal = 0;
                localStorage.removeItem('debutTravailSegment');
                localStorage.removeItem('debutDejeuner');
                localStorage.removeItem('heureDebutJournee'); // R√©initialisation du d√©but de journ√©e
                localStorage.setItem('lastDate', new Date().toDateString());
            } else {
                tempsTravailTotal = parseInt(localStorage.getItem('tempsTravailTotal')) || 0;
                debutTravailSegment = parseInt(localStorage.getItem('debutTravailSegment')) || null;
                debutDejeuner = parseInt(localStorage.getItem('debutDejeuner')) || null;
                etat = localStorage.getItem('etat') || 'STOPPE';
                // Chargement de l'heure de d√©but de journ√©e
                heureDebutJournee = parseInt(localStorage.getItem('heureDebutJournee')) || null;
            }
            updateTravailTotalDisplay();
            loadWeeklyRecap();
            updateButtons();

            if (etat === 'TRAVAIL' && debutTravailSegment) {
                // Relancer le chrono de travail apr√®s un rechargement
                startChrono(true);
            } else if (etat === 'DEJEUNER' && debutDejeuner) {
                // Relancer le chrono de d√©jeuner apr√®s un rechargement
                startChrono(false, true);
            }
        }

        /** Charge et affiche le r√©capitulatif hebdomadaire. */
        function loadWeeklyRecap() {
            const recap = JSON.parse(localStorage.getItem('weeklyRecap')) || [];
            WEEKLY_RECAP.innerHTML = '';
            if (recap.length === 0) {
                WEEKLY_RECAP.innerHTML = '<li>Aucune donn√©e enregistr√©e pour la semaine.</li>';
                return;
            }
            recap.forEach(entry => {
                const li = document.createElement('li');
                // Affichage du temps travaill√© ET des heures de d√©but/fin
                const debut = timestampToHM(entry.start);
                const fin = timestampToHM(entry.end);
                li.textContent = `${entry.date} : ${msToHMS(entry.time)} (De ${debut} √† ${fin})`;
                WEEKLY_RECAP.appendChild(li);
            });
        }

        /** Met √† jour l'√©tat des boutons en fonction de l'√©tat actuel. */
        function updateButtons() {
            BTN_TRAVAIL_START.disabled = etat !== 'STOPPE' && etat !== 'DEJEUNER';
            BTN_TRAVAIL_STOP.disabled = etat !== 'TRAVAIL';
            BTN_DEJEUNER_START.disabled = etat !== 'TRAVAIL';
            BTN_DEJEUNER_STOP.disabled = etat !== 'DEJEUNER';
        }

        // --- Logique du Chronom√®tre ---

        /** D√©marre le chronom√®tre affich√© (travail ou d√©jeuner). */
        function startChrono(isTravail, isReload = false) {
            // Arr√™ter tout intervalle existant
            clearInterval(travailInterval);
            clearInterval(dejeunerInterval);

            if (!isReload) {
                // En cas de nouveau d√©part, r√©initialiser l'affichage
                CHRONO_DISPLAY.textContent = "00:00:00";
            } else {
                // En cas de rechargement, mettre √† jour l'affichage imm√©diatement
                const startTimestamp = isTravail ? debutTravailSegment : debutDejeuner;
                if (startTimestamp) {
                    const elapsed = Date.now() - startTimestamp;
                    CHRONO_DISPLAY.textContent = msToHMS(elapsed);
                }
            }


            // Lancer le nouvel intervalle
            if (isTravail) {
                travailInterval = setInterval(() => {
                    const elapsed = Date.now() - debutTravailSegment;
                    CHRONO_DISPLAY.textContent = msToHMS(elapsed);
                }, 1000);
            } else {
                dejeunerInterval = setInterval(() => {
                    const elapsed = Date.now() - debutDejeuner;
                    CHRONO_DISPLAY.textContent = msToHMS(elapsed);
                }, 1000);
            }
        }

        // --- Fonctions de Pointage ---

        /** D√©marrer le travail. */
        function startTravail() {
            if (etat === 'TRAVAIL') return;
            
            // NOUVEAUT√â : Enregistrer l'heure de d√©but de journ√©e si c'est le premier lancement
            if (heureDebutJournee === null) {
                heureDebutJournee = Date.now();
            }

            // D√©jeuner s'arr√™te si c'√©tait le cas
            if (etat === 'DEJEUNER') {
                clearInterval(dejeunerInterval);
                debutDejeuner = null; // R√©initialiser le d√©but du d√©jeuner
            }

            // D√©marrer le nouveau segment de travail
            debutTravailSegment = Date.now();
            etat = 'TRAVAIL';
            startChrono(true); // Vrai = Travail

            saveState();
            updateButtons();
            CHRONO_DISPLAY.style.color = '#4CAF50';
            CHRONO_DISPLAY.style.backgroundColor = '#e8f5e9';
        }

        /** Arr√™ter le travail (Fin de journ√©e). */
        function stopTravail() {
            if (etat !== 'TRAVAIL') return;

            // Ajouter le temps du segment de travail actuel au total
            tempsTravailTotal += Date.now() - debutTravailSegment;
            debutTravailSegment = null; // R√©initialiser le d√©but du segment
            clearInterval(travailInterval);
            etat = 'STOPPE';

            updateTravailTotalDisplay();
            CHRONO_DISPLAY.textContent = msToHMS(tempsTravailTotal); // Afficher le total
            CHRONO_DISPLAY.style.color = '#333';
            CHRONO_DISPLAY.style.backgroundColor = '#f9f9f9';

            saveState();
            updateButtons();
        }

        /** D√©marrer le d√©jeuner (pause). */
        function startDejeuner() {
            if (etat !== 'TRAVAIL') return;

            // 1. Enregistrer le temps de travail √©coul√© avant la pause
            tempsTravailTotal += Date.now() - debutTravailSegment;
            clearInterval(travailInterval); // Arr√™ter le chrono travail
            debutTravailSegment = null; // Le segment de travail est termin√©

            // 2. D√©marrer le chrono d√©jeuner
            debutDejeuner = Date.now();
            etat = 'DEJEUNER';
            startChrono(false); // Faux = D√©jeuner

            updateTravailTotalDisplay();
            saveState();
            updateButtons();
            CHRONO_DISPLAY.style.color = '#FFC107';
            CHRONO_DISPLAY.style.backgroundColor = '#fff8e1';
        }

        /** Arr√™ter le d√©jeuner (reprise du travail). */
        function stopDejeuner() {
            if (etat !== 'DEJEUNER') return;

            // 1. Arr√™ter le chrono d√©jeuner (le temps de pause n'est pas stock√©)
            clearInterval(dejeunerInterval);
            debutDejeuner = null; // Le d√©jeuner est termin√©

            // 2. Relancer le travail l√† o√π il s'√©tait arr√™t√© (nouveau segment)
            debutTravailSegment = Date.now();
            etat = 'TRAVAIL';
            startChrono(true); // Vrai = Travail

            saveState();
            updateButtons();
            CHRONO_DISPLAY.style.color = '#4CAF50';
            CHRONO_DISPLAY.style.backgroundColor = '#e8f5e9';
        }


        /** Enregistre le total de la journ√©e dans le r√©capitulatif hebdomadaire. */
        function finDeJournee() {
            if (etat === 'DEJEUNER') {
                alert("Veuillez arr√™ter votre pause d√©jeuner avant de terminer la journ√©e.");
                return;
            }

            // Si encore en TRAVAIL, enregistrer le dernier segment
            if (etat === 'TRAVAIL') {
                tempsTravailTotal += Date.now() - debutTravailSegment;
            }

            if (tempsTravailTotal === 0) {
                alert("Aucun temps de travail enregistr√© pour cette journ√©e.");
                return;
            }

            // NOUVEAUT√â : Enregistrement de l'heure de fin
            heureFinJournee = Date.now();
            
            const dailyTime = tempsTravailTotal;
            const dailyDate = new Date().toLocaleDateString('fr-FR', {
                weekday: 'long',
                day: 'numeric',
                month: 'long'
            });

            // Sauvegarde dans le r√©cap
            let recap = JSON.parse(localStorage.getItem('weeklyRecap')) || [];
            recap.push({ 
                date: dailyDate, 
                time: dailyTime,
                // AJOUT DES HEURES DE D√âBUT ET DE FIN
                start: heureDebutJournee,
                end: heureFinJournee
            });
            localStorage.setItem('weeklyRecap', JSON.stringify(recap));

            // R√©initialisation de la journ√©e
            tempsTravailTotal = 0;
            debutTravailSegment = null;
            debutDejeuner = null;
            heureDebutJournee = null; // R√©initialisation
            heureFinJournee = null; // R√©initialisation
            etat = 'STOPPE';
            clearInterval(travailInterval);
            clearInterval(dejeunerInterval);

            localStorage.setItem('lastDate', null); // Force la r√©initialisation au prochain chargement
            saveState(); // Sauvegarde l'√©tat r√©initialis√©

            loadWeeklyRecap();
            updateTravailTotalDisplay();
            CHRONO_DISPLAY.textContent = "00:00:00"; // Affichage remis √† z√©ro
            updateButtons();
            
            CHRONO_DISPLAY.style.color = '#333'; // R√©initialiser le style du chrono
            CHRONO_DISPLAY.style.backgroundColor = '#f9f9f9';

            alert(`Journ√©e termin√©e ! Temps travaill√© enregistr√© : ${msToHMS(dailyTime)} (D√©but : ${timestampToHM(recap[recap.length - 1].start)}, Fin : ${timestampToHM(recap[recap.length - 1].end)})`);
        }
        
        // --- FONCTION POUR TOUT EFFACER ---

        /** Efface toutes les donn√©es de l'application (journ√©e en cours et r√©cap hebdomadaire). */
        function clearAllData() {
            if (!confirm("ATTENTION : √ätes-vous s√ªr de vouloir EFFACER TOUTES les donn√©es (temps journalier et r√©cap hebdomadaire) ? Cette action est irr√©versible.")) {
                return; // Annuler si l'utilisateur n'est pas s√ªr
            }

            // Arr√™ter tout chronom√®tre en cours
            clearInterval(travailInterval);
            clearInterval(dejeunerInterval);

            // Effacer toutes les cl√©s sp√©cifiques du localStorage pour cette application
            localStorage.removeItem('tempsTravailTotal');
            localStorage.removeItem('debutTravailSegment');
            localStorage.removeItem('debutDejeuner');
            localStorage.removeItem('etat');
            localStorage.removeItem('lastDate');
            localStorage.removeItem('weeklyRecap');
            localStorage.removeItem('heureDebutJournee'); // Suppression de la nouvelle cl√©

            // R√©initialiser les variables d'√©tat JavaScript
            tempsTravailTotal = 0;
            debutTravailSegment = null;
            debutDejeuner = null;
            heureDebutJournee = null; 
            heureFinJournee = null; 
            etat = 'STOPPE';

            // Mettre √† jour l'interface
            updateTravailTotalDisplay();
            loadWeeklyRecap();
            CHRONO_DISPLAY.textContent = "00:00:00";
            CHRONO_DISPLAY.style.color = '#333';
            CHRONO_DISPLAY.style.backgroundColor = '#f9f9f9';
            updateButtons();

            alert("Toutes les donn√©es de pointage ont √©t√© effac√©es.");
        }


        // --- Initialisation ---
        window.onload = loadState;

    </script>

</body>
</html>
